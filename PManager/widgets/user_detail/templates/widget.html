{% load floattags jsonify compressed %}
{% compressed_js 'user_detail' %}
<script>
    var global_user_id = {{ user_detail.user.id }};
    window.taskHtml = {{ user_detail.taskTemplate|jsonify|safe }};
    var USER_TIME_DATA = [
          {% for vals in user_detail.timeGraph %}{State:'{{ vals.date }}',freq:{time:{{ vals.time }}, tasks:{{ vals.tasksClosed }}}}{% if not forloop.last %},{% endif %}{% endfor %}
    ];
</script>
<div class="widget inner" id="user_detail">
    <div class="widget-title clearfix userInfo">
        <div class="pull-left">
        <i class="statusImg"></i>&nbsp;&nbsp;{{ user_detail.user.last_name }} {{ user_detail.user.first_name }} {% if user_detail.profile.vocation %}<small>({{ user_detail.profile.vocation }})</small>{% endif %}
        {% if user_detail.userIsEqualCurrentUser or user_detail.current_user_is_admin  %}
            <small>/ <a href="/profile/edit/?id={{ user_detail.user.id }}">Редактировать профиль</a></small>
        {% endif %}
        </div>
    </div><!--widget-title-->

    <div class="widget-body">
        <div class="user-personal row-fluid clearfix">
            <div class="user-personal-left clearfix">
                <div class="user-avatar pull-left">
                    <img style="width:100px;" class="img-rounded" src="{% if user_detail.profile.avatar %}{{ user_detail.profile.avatar }}{% else %}/static/images/avatar_unknown.png{% endif %}" alt="{{ user_detail.user.last_name }} {{ user_detail.user.first_name }}" />
                </div>

                <div class="user-info-right-from-avatar">
                    <div class="user-contacts pull-left">
                        <ul>
                            {% if user_detail.profile.icq %}<li class="user-icq">{{ user_detail.profile.icq }}</li>{% endif %}
                            {% if user_detail.profile.skype %}<li class="user-skype"><a href="skype:{{ user_detail.profile.skype }}?call">{{ user_detail.profile.skype }}</a></li>{% endif %}
                        </ul>
                    </div>
                    <div class="user-tasks-info pull-left">
                      <ul>
                        <li><b>Открытых задач:</b> <a href="#" class="js-link-tasks">{{ user_detail.taskSumm }}</a></li>
                        <li><b>Закрыто за последний месяц:</b> {{ user_detail.taskLastMonth }}</li>
                      </ul>
                    </div>
                    <div class="clearfix"></div>
                    <hr>
                    {% if user_detail.userIsEqualCurrentUser or user.is_superuser %}
                        <div class="dropdown js-specialties_search_wrapper">
                            <input type="text" name="additional_tags" data-user-id="{{ user_detail.user.id }}"
                                   placeholder="Укажите свои навыки" id="skillsDropdown"
                                   class="form-control js-save_specialty">
                            <ul class="dropdown-menu js-search_specialties" role="dropdown"
                                aria-labelledby="skillsDropdown">
                            </ul>
                        </div>
                    {% endif %}
                    <ul class="posibilities clearfix js-specialties {% if not user_detail.specialties %}hidden{% endif %}">
                        {% if user_detail.specialties %}
                            {% for specialty in user_detail.specialties %}
                                <li>
                                    <span>{{ specialty.name }}{% if specialty.weight %} ({{ specialty.weight }}){% endif %}
                                        {% if user_detail.userIsEqualCurrentUser or user.is_superuser %}
                                        <i class="fa fa-times js-delete_specialty" data-specialty="{{ specialty.id }}"></i>
                                        {% endif %}
                                    </span>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div><!--user-info-right-from-avatar-->

            </div>

            <div class="user-personal-left">
                <div class="user-prizes">
                    {% if user_detail.achievements %}
                    <ul class="user-prizes-slider clearfix">
                                {% for c in user_detail.achievements %}
                                    <li><img src="{{ c.smallImageUrl }}" alt="" width="64px">{{ c.name }}</li>
                                {% endfor %}
                      </ul>
                    {% endif %}
                </div>
            </div>

        </div><!--user-personal-->
        <hr>

        <div class="row-fluid clearfix user-inner-tabs" id="myTab">
            <div class="pull-left">
                <ul class="nav nav-pills js-tab-menu">
                    <li class="active"><a href="#svodka" role="tab" data-toggle="tab">Сводка</a></li>
                    <li><a href="#ychastvyet" role="tab" data-toggle="tab">Участвует в проектах</a></li>
                    <li><a href="#tekyshie_zadachi" role="tab" data-toggle="tab" class="js-current-tasks">Текущие задачи</a></li>
                    <li><a href="#dostizheniya" role="tab" data-toggle="tab">Достижения</a></li>
                    <li><a href="#activity" role="tab" data-toggle="tab">Активность</a></li>
                    {% if user_detail.use_git and user_detail.userIsEqualCurrentUser %}
                        <li><a href="#keys" role="tab" data-toggle="tab">Ключи</a></li>
                    {% endif %}
                    {% if user_detail.userIsEqualCurrentUser or user.is_superuser %}
                    <li><a href="#payments" role="tab" data-toggle="tab">Оплаты</a></li>
                    {% endif %}
                </ul>
            </div>
            <div class="pull-right">
                {% if user_detail.current_user_is_admin %}
                <form method="POST" action="" class="inline-block"><input name="action" type="hidden" value="delete_user" />
                    <input type="submit" class="js-delete-user btn btn-danger" value="Удалить пользователя" /></form>&nbsp;&nbsp;
                {% endif %}
                <a href="#add-project" class="btn btn-success js-add-project" role="tab" data-toggle="tab">Добавить в проект</a>
            </div>
        </div><!--ТАБЫ-->
        <hr>

            <div class="tab-content">
                <div class="tab-pane active" id="svodka">
                    <div class="statistic-wrapper clearfix">
                          <div class="statistic-list">
                                {% if user_detail.user.last_activity %}
                                <p>Последняя активность: <strong>{{ user_detail.user.last_activity }}</strong></p>
                                {% endif %}
                                {% if user_detail.allTaskClosed %}
                                <p>Всего закрыто задач: <strong>{{ user_detail.allTaskClosed }}</strong></p>
                                <hr />
                                {% endif %}
                                <hr />
                                {% if user_detail.profile.sp_price and user_detail.current_user_is_admin or user_detail.profile.sp_price and user_detail.userIsEqualCurrentUser %}
                                <h4>Финансы</h4>
                                <p>Ставка: <span class="stavka {% if not user_detail.profile.rating %}{% elif user_detail.profile.rating < 0 %}danger{% else %}success{% endif %}">
                                    {{ user_detail.profile.sp_price }}<span class="bonus">{% if user_detail.profile.rating %}{{ user_detail.profile.rating }}{% else %}0{% endif %}</span></span>SP</p>

                                <div class="sp">
                                    Всего SP:
                                    <span class="dropdown dropup">
                                        <a data-toggle="dropdown" href="javascript:void(0);">{{ user_detail.profile.sp.summ }}</a>
                                        <ul class="dropdown-menu">
                                            {% for arBet in user_detail.bets %}
                                                {% if arBet.price %}
                                                <li>{{ arBet.project }} —  <b>{{ arBet.price }} бонусов. ({{ arBet.bet }} бонусов./ч.)</b></li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </span>
                                </div>
                                <p>Не погашено: {{ user_detail.profile.sp.rest|default_if_none:'0' }}</p>
                                {% endif %}
                           </div>

                          <div class="statistic-graph-wrapper">
                              <div class="statistic-graph"><h3>Затраченное время</h3>
                                    <div id='dashboard'></div>
                              </div>
                              <div class="statistic-detail js-user-legend"></div>
                          </div>
                    </div>
                </div><!--ВКЛАДКА "СВОДКА" - svodka-->
                <div class="tab-pane" id="ychastvyet">
                    {% for project in user_detail.user_projects %}
                        <div class="media clearfix">
                        	<img src="/static/images/avatar_unknown.png" class="img-thumbnail pull-left" width="100" />
                            <h3>{{ project.name }}</h3>
                            <ul class="list-inline" >
                                {% if project.canEdit  or 'client' in project.roles %}
                                <li><div {% if project.canEdit %}class="checkbox"{% endif %}><label>
                                    {% if project.canEdit %}
                                    <input class="js-role-check" {% if 'client' in project.roles %}checked{% endif %} data-project="{{ project.id }}"
                                         data-user-id="{{ user_detail.user.id }}" name="client" value="1" type="checkbox">
                                    {% endif %}
                                    <span class="fa fa-users"></span>
                                    Клиент</label></div></li>
                                {% endif %}
                                {% if project.canEdit  or 'manager' in project.roles %}
                                <li><div {% if project.canEdit %}class="checkbox"{% endif %}><label>
                                    {% if project.canEdit %}
                                    <input class="js-role-check" {% if 'manager' in project.roles %}checked{% endif %} data-project="{{ project.id }}"
                                           data-user-id="{{ user_detail.user.id }}" name="manager" value="1" type="checkbox">
                                    {% endif %}
                                    <span class="fa fa-cogs"></span>
                                    Менеджер</label></div></li>
                                {% endif %}
                                {% if project.canEdit  or 'employee' in project.roles %}
                                <li><div {% if project.canEdit %}class="checkbox"{% endif %}><label>
                                    {% if project.canEdit %}
                                    <input class="js-role-check" {% if 'employee' in project.roles %}checked{% endif %} data-project="{{ project.id }}"
                                           data-user-id="{{ user_detail.user.id }}" name="employee" value="1" type="checkbox">
                                    {% endif %}
                                    <span class="fa fa-user"></span>
                                    Разработчик</label></div></li>
                                {% endif %}
                          </ul>
                        </div><!--ychastvyet-item-->
                        {% if not forloop.last %}<hr />{% endif %}
                    {% endfor %}
                </div><!--ВКЛАДКА "УЧАСТВУЕТ" ychastvyet-->
                <div class="js-tasks tab-pane" id="tekyshie_zadachi">
                    <script language="javascript">
                    var aTaskList = [], arTimers = {}, taskRespSummary = {};
                    {% for task in user_detail.task.list.tasks %}
                        aTaskList.push({{ task|jsonify|safe }});
                        taskRespSummary['{{ task.id }}'] = {{ task.responsibleList|jsonify|safe }}
                        {% if task.time %}
                            arTimers['{{ task.id }}'] = new PM_Timer({{ task.time|jsonify|safe }});
                            {% if task.startedTimerExist %}
                                arTimers['{{ task.id }}'].start();
                            {% endif %}
                        {% endif %}
                    {% empty %}
                       document.write('<p>Нет ни одной задачи</p>');
                    {% endfor %}
                    </script>
                </div>
                <div class="tab-pane" id="dostizheniya">
                    {% if user_detail.achievements %}
                        {% for c in user_detail.achievements %}
                            <div class="dostizheniya-item">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                    <td class="dostizheniya-item-img"><a href="#"><img width="64" src="{{ c.smallImageUrl }}" alt="{{ c.name }}" /></a></td>
                                    <td class="dostizheniya-item-text">
                                    <h4>{{ c.name }}</h4>
                                    <p class="date">{{ c.date }}</p>
                                    <p>{{ c.description|safe }}</p>
                                    </td>
                                    </tr>
                                </table>
                            </div>
                            {% if not forloop.last %}<hr />{% endif %}
                        {% endfor %}
                    {% endif %}

{#                        <hr />#}

                </div><!--ВКЛАДКА "ДОСТИЖЕНИЯ"-->

                <div class="tab-pane" id="activity">
                    <table class="table table-bordered table-striped">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Время</th>
                          <th>Задача</th>
                          <th>Комментарий</th>
                          <th>Добавлено</th>
                        </tr>
                      </thead>
                      <tbody>
                      {% for timer in user_detail.timers %}
                          <tr>
                              <td>{{ timer.id }}</td>
                              <td>{{ timer.time }}</td>
                              <td><a href="{{ timer.task_url }}">{{ timer.task }}</a></td>
                              <td>{{ timer.comment|safe }}</td>
                              <td>{{ timer.date }}</td>
                          </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                    <div align="center">
                	</div>
                </div><!--ВКЛАДКА "Активность"-->
                {% if user_detail.use_git and user_detail.userIsEqualCurrentUser %}
                    <div class="tab-pane" id="keys">
                        <button class="btn btn-success js-openKeyForm"><i class="fa fa-plus"></i>&nbsp;Добавить ключ</button>
                        <div>&nbsp;</div>
                        {% if user_detail.keys %}
                        <table class="table table-bordered table-striped">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Создан</th>
                              <th>Имя</th>
                              <th>Действия</th>
                            </tr>
                          </thead>
                          <tbody>
                          {% for key in user_detail.keys %}
                              <tr>
                                  <td>{{ key.id }}</td>
                                  <td>{{ key.created_at }}</td>
                                  <td>{{ key.name }}</td>
                                  <td><a class="btn btn-alert js-deleteKey"><i class="fa fa-remove"></i>&nbsp;Удалить</a></td>
                              </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                        {% endif %}
                        <a href="/wiki/how-to-setup-repository#creating-keys">Как создать ключи?</a>
                    </div><!--ВКЛАДКА "Ключи"-->
                {% endif %}
                {% if user_detail.userIsEqualCurrentUser or user.is_superuser %}
	                <div class="tab-pane" id="payments">
	                        {% if user_detail.payments %}
	                        <table class="table table-bordered table-striped">
	                          <thead>
	                            <tr>
	                              <th>#</th>
	                              <th>Дата</th>
		                          <th>Сумма</th>
	                              <th>Проект</th>
	                            </tr>
	                          </thead>
	                          <tbody>
	                          {% for payment in user_detail.payments %}
	                              <tr>
	                                  <td>{{ forloop.revcounter}}</td>
	                                  <td>{{ payment.date }}</td>
	                                  <td>{{ payment.value }}</td>
		                              <td>{{ payment.project.name }}</td>
	                              </tr>
	                          {% endfor %}
	                          </tbody>
	                        </table>
                            {% else %}
                            <p>Нет ни одной оплаты</p>
	                        {% endif %}
	                    </div><!--ВКЛАДКА "Оплаты"-->
                {% endif %}
                <div class="tab-pane" id="add-project">
                    <h2>Добавить пользователя в проект</h2>
                    {% if user_detail.projectsForAddUser %}
                        <form name="add_to_project" method="POST" action="" role="form">
                            <input type="hidden" name="action" value="add_to_project" />
                            <div class="form-group">
                                <label for="exampleInputEmail1">Проект</label>
                                <select name="project" class="form-control">
                                    <option>Выберите проект</option>
                                    {% for project in user_detail.projectsForAddUser %}
                                        <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="exampleInputEmail1">Права</label>
                                <select name="role" class="form-control">
                                    <option>Выберите роль</option>
                                    {% for role in user_detail.roles %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <input type="submit" class="btn-default btn" name="" value="Добавить" />
                        </form>
                    {% else %}
                        <p>Пользователь уже состоит во всех ваших проектах</p>
                    {% endif %}
                </div> <!--ВКЛАДКА "ДОБАВИТЬ ПРОЕКТ"-->
            </div>

            <script>
               {% if user_detail.use_git and user_detail.userIsEqualCurrentUser %}
                   $('.js-openKeyForm').click(function(){
                        $.get('/user_key_handle/add', function(response){
                            $('body').prepend(response);
                            $('.js-keyForm').fadeIn(200);
                        })
                   });
                   $('.js-deleteKey').click(function(){
                        var row = $(this).parents('tr');
                        var key_name = row.find('td:eq(2)').html();
                        var key_id = row.find('td:eq(0)').html();
                        if(confirm('Вы точно хотите удалить ключ ' + key_name)){
                            $.get('/user_key_handle/remove/' + key_id, function(response){
                                if(response.errors) {
                                    alert('Не удалось удалить ключ ' + key_name);
                                    return false;
                                }
                                row.remove();
                                if(row.parents('tbody').find('tr').length == 0){
                                    row.parent('table').remove();
                                }
                                return false;
                            });
                        }
                        return false;
                   });
              {% endif %}
            </script>
    </div><!--widget-body-->
</div><!--widget-->