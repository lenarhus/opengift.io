{% load jsonify compressed %}
{% if kanban.error %}
    <div class="kanban">
        <div class="widget inner">
            <div class="project-row js-project-row">
                <div class="project-header js-project-header">
                    <div class="widget-title clearfix">
                        Необходимо выбрать проект
                    </div>
                </div>
            </div>
        </div>
    </div>
{% elif not kanban.projects_data %}
    <div class="kanban">
        <div class="widget inner">
            <div class="project-header js-project-header">
                <div class="widget-title clearfix">
                    {% if kanban.current_project %}
                        {{ kanban.current_project }}
                    {% else %}
                        Все проекты
                    {% endif %}
                </div>
            </div>
            <p style="width: 100%; text-align: center;">У вас пока нет ни одной задачи</p>
        </div>
    </div>
{% else %}
    {% block stylesheets %}
        <link rel="stylesheet" href="/static/css/external/chosen.css"/>
    {% endblock %}
    {% block scripts %}
        {% compressed_js 'kanban' %}
    {% endblock %}
    <div class="kanban">
        {% for project in kanban.projects_data %}
            <style>
                {% for status in project.columns %}
                    #project_{{ project.id }} .tasks-{{ status.code }},
                    #project_{{ project.id }} .project-row-headers .tasks-{{ status.code }} {
                        width: {{ project.status_width }}%;
                    }
                {% endfor %}

                .kanban .project-row .tasks-revision,
                .kanban .project-row-headers .tasks-revision {
                    width: {{ project.status_width }}%;
                }

                .kanban .project-row .tasks-column.tasks-ready {
                    margin-right: 0;
                }
            </style>
            <div class="widget inner">
                <div class="project-row js-project-row" id="project_{{ project.id }}" data-project="{{ project.id }}">
                    <div class="project-header js-project-header">
                        <div class="widget-title clearfix">
                            {{ project.name }}
                            <div style="float: right;"><a href="/project/{{ project.id }}/#additional_settings">Настроить
                                столбцы</a></div>
                        </div>
                        <div>
                            <select class="js-user_source" multiple
                                    style="width:100%" data-placeholder="Выберите пользователей">
                                {% for user in project.user_source %}
                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                {% endfor %}
                            </select>

                        </div>

                        <div class="project-row-headers">
                            <table width="100%">
                                <tr>
                                    {% for status in project.columns %}
                                        <td class="tasks-header tasks-{{ status.code }}">
                                            {{ status.name }}
                                        </td>
                                    {% endfor %}
                                </tr>
                            </table>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                    <div class="tasks-wrapper js-tasks-wrapper" rel="{{ project.id }}">
                        <table width="100%">
                            <tr>
                                {% for status in project.columns %}
                                    <td class="tasks-column task-droppable js-tasks-column js-task-droppable tasks-{{ status.code }} js-tasks-{{ status.code }}"
                                        rel="{{ status.code }}" data-prop="{{ status.prop }}">

                                    </td>
                                {% endfor %}
                            </tr>
                        </table>
                        <div class="clearfix"></div>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
        {% endfor %}
    </div>
    <script type="text/javascript">
        (function ($) {
            $.JSONstorage = function (key, value) {
                var STORAGE_PREFIX = 'hl_kb_';
                if (typeof value === "undefined") {
                    val = window.localStorage.getItem(STORAGE_PREFIX + key);
                    if (val == null) {
                        return [];
                    }
                    try {
                        val = JSON.parse(val);
                        return val;
                    }
                    catch (e) {
                        return [];
                    }
                }
                else {
                    window.localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                    return value;
                }
            }
        })(jQuery);
        var taskRespSummary = {};
        {% for project in kanban.projects_data %}
            {% for task_data in project.tasks %}
                taskRespSummary['{{task_data.task.id}}'] = {{ task_data.responsibleList|jsonify|safe }};
            {% endfor %}
        {% endfor %}

        $(function () {

        });
    </script>
{% endif %}

<div class="js-task-wrapper-template" style="display: none">
    <div class="task-card js-task-card js_task_responsibles message-info">
        <div class="task-status js-task-status"></div>
        <div class="name">
            <a href="" class="js-task-name">
            </a><br />
            <a href="#" class="js-plan-time"></a>
        </div>
        <div class="executor js-task-executor dropdown" rel="">
            <a data-toggle="dropdown" class="js-select_resp">
                <div class="avatar_container js-avatar-container">
                    <i class="fa fa-share"></i>
                </div>
            </a>
        </div>
        <div class="properties-icon js-options_popup">
            <a class="btn_manage dropdown-toggle js-task_menu">
                <span class="fa fa-gear" title="Действия" style="font-size: 20px"></span>
            </a>
        </div>
    </div>
</div>