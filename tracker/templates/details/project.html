{% extends "main/base.html" %}
{% load thumbnail get_settings %}
{% block content %}
    <script type="text/javascript" src="/static/js/libs/clipboard/zclib.js"></script>
    <script type="text/javascript" src="/static/js/pm/ajax_inputs.js"></script>
    <script type="text/javascript">
        function clipboardAppend(t) {
            $(t).clipboard({
                path: '/static/js/libs/clipboard/jquery.clipboard.swf',
                copy: function () {
                    $(t).data('text', $(t).text()).text('пароль скопирован');
                    setTimeout(function () {
                        $(t).text($(t).data('text'));
                    }, 2000);
                    return $(t).data('password');
                }
            });
        }

        $(function () {
            $('a.js-copy-password').each(function () {
                clipboardAppend(this);
            });

            $('.js-interface-container').on('click', '.js-interface-remove', function () {
                var $interface = $(this).closest('.js-interface-block');
                var id = $interface.data('id');
                $interface.remove();
                $.post(
                        '/remove_interface/',
                        {
                            'id': id
                        }
                );
            });

            window.ajaxInputs();
        });
    </script>
           <script type="text/javascript">
         $(document).ready(function(){
            var requestForServer = function(is_new) {
                if (is_new !== true) {
                    is_new = false;
                }
                $('.js-working').show();
                var servUp = $.ajax({
                    type: "GET",
                    url: "/project/{{ project.id }}/server-setup",
                    data: { "new" : is_new }
                });
                servUp.done(function(msg){
                    if(confirm('Сервер запустится в течении 10 минут')){
                        window.location.reload();
                    } else {
                        window.location.reload();
                    }

                });
                servUp.fail(function(jqXHR, textStatus){
                    alert('Произошла ошибка, пожалуйста свяжитесь с администратором.');
                    $('.js-working').hide();
                });
            }
            $('.js-server-status').click(function(){
                $('.js-working').show();
                var servStatus = $.ajax({
                    type: "GET",
                    url: "/project/{{ project.id }}/server-status"
                });
                servStatus.done(function(msg){
                    $('.js-working').hide();
                    console.log(msg);
                    if (msg === 'OK') {
                        alert('Сервер работает');
                    }
                    else {
                        alert('Сервер не работает');
                    }

                    //window.location.reload
                });
                servStatus.fail(function(jqXHR, textStatus){
                    alert('Произошла ошибка, пожалуйста свяжитесь с администратором.');
                    $('.js-working').hide();
                });
            });
            $('.js-server-create').click(function(){
                requestForServer(true);
            });
         });
        </script>
    <link type="text/css" rel="stylesheet" href="/static/css/project.edit.css"/>
    <div class="widget">

    <div class="project-info-area clearfix">
        <div class="project-info-left">
            {% if project.imagePath %}
                <span class="project-info-avatar">
                    <span class="project-info-avatar-upload">
                        <input type="file">
                        <a href="" class="btn btn-success">Выбрать</a>
                    </span>
                    <img width="100px" src="{{ project.imagePath|thumbnail:'100x100' }}"/>
                </span>
            {% else %}
                <span class="project-info-avatar"><img width="100px" src=/PManager/static/img/no-photo.png"/></span>
            {% endif %}
        </div>
        <div class="project-info-right">
            <h1>
                {% if canEdit %}
                <a href="/project/edit/?id={{ project.id }}"></a>
                <span class="project-edit-link-editable">{{ project.name }}</span>
                {% else %}
                {{ project.name }}
                {% endif %}
                <input type="text" class="project-edit-input form-control" value="{{ project.name }}" class="">
            </h1>
            <script>
                $(function() {
                    $('.editable-textarea-click').click(function(e) {
                        $(this).hide();
                        $('.editable-textarea').show().focus();
                        e.stopPropagation();
                    });
                    $('.project-edit-link-editable').click(function(e) {
                        $(this).hide();
                        $('.project-edit-input').show().focus();
                        e.stopPropagation();
                    });

                    $('.editable-textarea, .project-edit-input').click(function(e) {
                        e.stopPropagation();
                    });

                    $(document).click(function () {
                        $('.editable-textarea-click, .project-edit-link-editable').show();
                        $('.editable-textarea, .project-edit-input').hide();
                    });
                });
            </script>
            <p class="editable-textarea-wrapper">
                <span class="editable-textarea-click">{{ project.description }}</span>
                <textarea class="editable-textarea form-control">{{ project.description }}</textarea>
            </p>
        </div>
    </div>
    <hr class="clearfix">
    <ul id="myTab" role="tablist" class="user-list-settings clearfix">
        <li role="accesses" class="active">
            <a class="btn btn-default" data-toggle="tab" aria-controls="accesses" href="#accesses" aria-expanded="true">Доступы</a>
        </li>
        {% if bCurUserIsAuthor %}
        <li role="participants_and_rates">
            <a class="btn btn-default" data-toggle="tab" aria-controls="participants_and_rates" href="#participants_and_rates" aria-expanded="false">Участники и ставки</a>
        </li>
        {% endif %}
        <li role="integration">
            <a class="btn btn-default" data-toggle="tab" aria-controls="integration" href="#integration" aria-expanded="false">Непрерывная интеграция</a>
        </li>
        <li role="additional_settings">
            <a class="btn btn-default" data-toggle="tab" aria-controls="additional_settings" href="#additional_settings" aria-expanded="false">Дополнительные настройки</a>
        </li>
        <li>
            {% if canDelete and not project.closed %}
            <a class="btn btn-danger" href="?archive=Y">Перенести в архив</a>
            {% endif %}
        </li>
    </ul>
    <div class="tab-content">
        <div id="accesses" class="tab-pane active" role="tabpanel">
            <div class="add-interface">
                <form enctype="multipart/form-data" class="js-add-interface" method="POST" action="/add_interface/">
                    <input type="hidden" name="pid" value="{{ project.id }}"/>

                    <div class="my-row clearfix">
                        <div class="my-row-3">
                            <div class="my-row-4">
                                <h6>Тип соединения</h6>
                                <select class="form-control" name="protocol">
                                    <option value="http">WEB</option>
                                    <option value="ssh">SSH</option>
                                    <option value="ftp">FTP</option>
                                    <option value="rdp">RDP</option>
                                </select>
                            </div>
                            <div class="my-row-6">
                                <h6>Адрес</h6>
                                <input type="text" value="" name="address" placeholder="Введите адрес..."
                                       class="form-control"/>
                            </div>
                        </div>
                        <div class="my-row-3">
                            <h6>Название</h6>
                            <input type="text" value="" name="name" placeholder="Введите название..." class="form-control">
                        </div>
                        <div class="my-row-3">
                            <h6>Доступен</h6>
                            <label class="checkbox-inline"><input name="access_roles" checked type="checkbox" value="1">
                                Клиенты</label>
                            <label class="checkbox-inline"><input name="access_roles" checked type="checkbox" value="2">
                                Разработчики</label>
                            <label class="checkbox-inline"><input name="access_roles" checked type="checkbox" value="3">
                                Менеджеры</label>
                        </div>
                    </div>

                    <div class="my-row clearfix">
                        <div class="my-row-3">
                            <h6>Имя пользователя</h6>
                            <input type="text" value="" name="username" placeholder="Введите имя пользователя..."
                                   class="form-control">
                        </div>
                        <div class="my-row-3">
                            <h6>Пароль</h6>
                            <input type="password" value="" name="password" placeholder="Введите пароль..."
                                   class="form-control">
                        </div>
                        <div class="my-row-3">
                            <input type="submit" class="btn btn-success"
                                   onclick="$('.js-add-interface').ajaxSubmit(function(data){var $ic = $('.js-interface-container'); $ic.append(data);clipboardAppend($ic.find('.js-copy-password').last());});return false;"
                                   value="Добавить интерфейс"/>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% if bCurUserIsAuthor %}
        <div id="participants_and_rates" class="tab-pane" role="tabpanel">
            <div class="nachislenie-bonusov">
                <h2>Начисление бонусов (очков истории)</h2>
                <hr>
                {% for roleName, o in roles.items %}
                <ul class="developer-manager-list clearfix" role="tablist">
                    <li class="active" role="manager">
                        <a aria-expanded="true" href="#manager" aria-controls="manager" data-toggle="tab" class="btn btn-default">{{ roleName }}</a>
                    </li>

                    <li role="developer">
                        <a aria-expanded="false" href="#developer" aria-controls="developer" data-toggle="tab" class="btn btn-default">Разработчики проекта</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="manager">
                        <p>{{ o.text }}:</p>
                        <div class="clearfix user-role-block-wrapper">
                            {% for user in o.users %}
                            <div class="user-role-block">
                                <div class="avatar">
                                    <a href="/user_detail/?id=1" class="pull-left"><img width="90px" class="media-object img-thumbnail" src="{% get_settings "HTTP_ROOT_URL" %}/static/images/avatar_male.png"></a>
                                </div>
                                <div class="desc">
                                    <h4><a href="/user_detail/?id={{ user.id }}">{{ user.first_name }} {{ user.last_name }}</a></h4>
                                    <div class="col-wrapper clearfix">
                                        <div class="col-7">
                                            <p><b>Форма начисления бонусов:</b> <a href="#" title="Бонусы начисляются при закрытии задачи. Плановое время распределяется среди исполнителей поровну. За реальное время бонусы начисляются согласно таймеру.">?</a></p>
                                            <select class="js-ajax-input form-control" data-action="update_payment_type" data-role="{{ user.role_id }}">
                                                <option value="real_time" {% if o.role.payment_type == 'real_time' %}
                                                selected="selected"{% endif %}>
                                                За реальное время
                                                </option>
                                                <option value="plan_time" {% if o.role.payment_type == 'plan_time' %}
                                                selected="selected"{% endif %}>
                                                За плановое время
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <p><b>Ставка:</b></p>
                                            <div class="input-group">
                                                <input type="text" class="js-ajax-input form-control" data-action="update_rate"
                                                       data-role="{{ user.role_id }}" value="{{ user.rate|default_if_none:'' }}"
                                                {% if user.defaultRate %}placeholder="{{ user.defaultRate }}"{% endif %} />
                                                <div class="input-group-addon">SP</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="clearfix"></div>
                                <div class="bonuses clearfix">
                                    <span><b>Накоплено бонусов:</b> {{ user.sum|default_if_none:"0" }}</span>
                                    <button class="btn btn-success js-bonus-complete" rel="{{ user.role_id }}" data-sum="{{ user.sum|default_if_none:'' }}">Списать бонусы</button>
                                </div>


                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="developer">2</div>
                </div>
                {% endfor %}
                <div class="js-user-pay-win hidden">
                    <div class="user-pay-win">
                        <form>
                            <input type="hidden" class="js-input-role-id" value=""/>
                            <h3>Количество бонусов: </h3>
                            <p><input type="text" class="js-input-user-sum form-control" value=""/></p>
                            <input type="button" class="btn btn-success form-control" onclick="sendPayment(this);return false;"
                                   value="Погасить бонусы"/>
                        </form>
                    </div>
                </div>
                <script type="text/javascript">
                    function sendPayment(el) {
                        var $form = $(el).closest('form'),
                                data = {'action': 'send_payment'};
                        data['role'] = parseInt($form.find('.js-input-role-id').val());
                        data['sum'] = parseInt($form.find('.js-input-user-sum').val());
                        PM_AjaxPost(
                                document.URL,
                                data,
                                function (data) {
                                    if (data['result']) document.location.reload();
                                },
                                'json'
                        );
                    }
                    $(function () {
                        $('.js-bonus-complete').click(function () {
                            $.fancybox({'content': $('.js-user-pay-win').html()});
                            $('.js-input-user-sum').val($(this).data('sum') > 0 ? $(this).data('sum') : 0);
                            $('.js-input-role-id').val($(this).attr('rel'));
                            return false;
                        })
                    })
                </script>
            </div>
        </div>
        {% endif %}

        <div id="integration" class="tab-pane" role="tabpanel">
            <div class="integration-wrapper clearfix">
                <script>
                    $(document).ready(function () {
                        var timerCheckFields = false;
                        $('.js-repository').click(function (ev) {
                            if (!$(this).prop('checked')) {
                                $('.js-repository-value').val('');
                                $('.js-hiddable').hide();
                            } else {
                                $('.js-hiddable').show();
                                $('.js-repository-value').val(transliterate($('#id_name').val()));
                                $('.js-repository-value').focus();
                            }
                            checkFields();
                        });
                        $('#id_name').keyup(function () {
                            var projectName = $(this).val();
                            var repoName = transliterate(projectName);
                            if (in_sync) {
                                $('.js-repository-value').val(repoName);
                                unmarkRepName();
                                setCheckFieldsTimer();
                            }

                        });
                        $('#id_name').change(function () {
                            unmarkRepName();
                        });
                        function unmarkRepName() {
                            $('.js-repository-value').next('i').removeClass('fa-check-circle').removeClass('fa-exclamation-circle').removeClass('fa-spinner').removeClass('fa-spin').css('color', 'black');
                        }

                        function markSuccessRepName() {
                            $('.js-repository-value').next('i').addClass('fa-check-circle').removeClass('fa-exclamation-circle').removeClass('fa-spinner').removeClass('fa-spin').css('color', 'green');
                        }

                        function markErrorRepName() {
                            $('.js-repository-value').next('i').removeClass('fa-check-circle').addClass('fa-exclamation-circle').removeClass('fa-spinner').removeClass('fa-spin').css('color', 'red');
                        }

                        function enableSubmit() {
                            $('.js-submit').removeAttr('disabled');
                        }

                        function disableSubmit() {
                            $('.js-submit').attr('disabled', 'disabled');
                        }

                        function setCheckFieldsTimer() {
                            if (timerCheckFields) {
                                clearTimeout(timerCheckFields);
                            }
                            timerCheckFields = setTimeout(checkFields, 700);
                        }

                        function checkFields() {
                            var projectName = $('#id_name').val();
                            var isRepo = $('.js-repository').prop('checked');
                            if (!isRepo) {
                                $('.js-repository-value').val('');
                                enableSubmit();
                                unmarkRepName();
                                return;
                            }
                            if (in_sync) {
                                var repoName = transliterate($('.js-repository-value').val()) || transliterate(projectName);
                            }
                            else {
                                var repoName = transliterate($('.js-repository-value').val());
                            }
                            $('.js-repository-value').val(repoName);
                            $('.js-repository-value').next('i').addClass('fa-spinner').addClass('fa-spin');
                            $.post('/project/edit/check_repository_name', {'repoName': repoName }, function (response) {
                                if (response == "OK") {
                                    markSuccessRepName();
                                    enableSubmit();
                                }
                                else if (response == "ERROR") {
                                    markErrorRepName();
                                    disableSubmit();
                                }
                                else {
                                    $('.js-repository-value').val(response);
                                    markSuccessRepName();
                                    enableSubmit();
                                }
                            });
                        };
                        disableSubmit();
                        $('#id_name').blur(checkFields);
                        var in_sync = true;
                        $('.js-repository-value').focus(function () {
                            if ($(this).val() == transliterate($('#id_name').val())) {
                                in_sync = true;
                            } else {
                                in_sync = false;
                            }
                        });
                        $('.js-repository-value').keyup(function () {
                            setCheckFieldsTimer();
                            if ($(this).val() == transliterate($('#id_name').val())) {
                                in_sync = true;
                            } else {
                                in_sync = false;
                            }
                        });
                        $('.js-repository-value').blur(function (ev) {
                            checkFields();
                        });
                        checkFields();
                    });
                </script>
                <div class="integration-left">
                    <h2>GIT</h2>
                    <hr>
                    <p class="checkbox">
                        <label>
                            <input type="checkbox" name="" id="" class="js-repository">&nbsp;Использовать GIT
                        </label>
                    </p>
                    <p class="js-hiddable" style="display: none; position: relative;">
                        <label>Имя репозитория</label>
                        <input type="text" name="repository"
                               value="{% if project_edit.form.repository.value != None %}{{ project_edit.form.repository.value }}{% endif %}" class="form-control js-repository-value" {% if not project_edit.is_new and project_edit.form.repository.value %}readonly{% endif %}/>
                        <i class="fa fa-icon" style="position: absolute;right: 25px;top: 10px;font-size: 16px;"></i>
                    </p>
                    <p class="checkbox">
                        <label>
                            <input type="checkbox" name="" id="">&nbsp;Запретить коммиты не в задачу
                        </label>
                    </p>
                    <p class="checkbox">
                        <label>
                            <input type="checkbox" name="" id="">&nbsp;Запретить коммиты с ошибками
                        </label>
                    </p>
                </div>
                <div class="integration-right">
                    <h2>Тестовый сервер</h2>
                    <hr>
                    {% if project.api_key %}
                    <div class="clearfix test-server">

                        <div class="server-name"><b>{{ project.repository }}.heliard-platform.ru</b></div>
                        <div class="server-status">
                            <a href="#" class="btn btn-success js-server-status">Проверить статус сервера</a>
                        </div>
                        <div class="clearfix"></div>
                        <div class="server-progress working js-working" style="display: none;">
                            <div class="progress progress-striped active">
                                <div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">
                                    <span class="sr-only">Запускаем сервер...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <p class="colored-bg bg-success">...</p>
                    <p class="colored-bg bg-info">...</p>
                    <p class="colored-bg bg-warning">...</p>
                    <p class="colored-bg bg-danger">...</p>
                    <div class="js-interface-container">
                        {{ interfaces|safe }}
                    </div>
                </div>
            </div>

            <div class="row-fluid clearfix project-buttons">
                <div class="pull-right">
                    {% if project.repository and not project.api_key %}
                    <a href="#" class="btn btn-warning js-server-create">
                        Выгрузить на тестовый сервер
                    </a>
                    {% endif %}
                    <a href="#" class="btn btn-warning js-server-create">
                        Выгрузить на тестовый сервер
                    </a>
                </div>
                <div class="clearfix"></div>
            </div>



        </div>

        <div id="additional_settings" class="tab-pane" role="tabpanel">
            <p class="checkbox">
                <label>
                    <input type="checkbox" name="" id="">&nbsp;Архив
                </label>
            </p>
            <p class="checkbox">
                <label>
                    <input type="checkbox" name="" id="">&nbsp;Разрешать выполнять не подтвержденные задачи
                </label>
            </p>
            <p class="checkbox">
                <label>
                    <input type="checkbox" name="" id="">&nbsp;Скрывать сообщения клиента и исполнителя друг от друга
                </label>
            </p>
        </div>
    </div>

    <!--<div class="media clearfix">

        <div class="media-body">
            {% for roleName, role in roles.items %}
                <p>{{ roleName }}: {% for user in role.users %}<a href="/user_detail/?id={{ user.id }}">
                    {{ user.first_name }} {{ user.last_name }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
                </p>
            {% endfor %}
        </div>
        <hr/>
    </div><hr/>-->


    </div><!--widget-->
{% endblock %}
