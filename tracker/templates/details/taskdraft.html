{% extends "main/base.html" %}
{% load thumbnail %}
{% load jsonify %}
{% load compressed %}
{% block stylesheets %}
    {% compressed_css 'taskdraft_detail' %}
{% endblock %}
{% block content %}
    <div class="widget inner draft">
        <div class="widget-title clearfix">
            Список задач: {{ draft }}
            <div class="status" style="float:right">
                Статус: {{ draft.status_humanize }}
            </div>
        </div>
        <div class="widget-body">

            <div class="invite-wrapper clearfix">
                <div class="invite-user-list">
                    <div class="clearfix">
                        <h4 class="invite-developers-title">Список участников:</h4>
                        {% if request.user.id == draft.author.id and tasks %}
                        <div class="invite-developers">
                            <a href="/taskdraft/{{ draft.slug }}/resend-invites"
                               class="btn btn-success js-invite-developers">
                                <i class="fa fa-paper-plane"></i>&nbsp;Отправить приглашения
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    <ul class="invite-user-list-list">
                        {% for user in users %}
                        <li class="clearfix">
                            <div class="invite-user-item-left">
                                <div class="avatar_container js-avatar-container" data-size="70" rel='{{ user.get_profile.avatar_rel|jsonify|safe }}'></div>
                            </div>
                            <div class="invite-user-item-right">
                                <a href="/user_detail/?id={{ user.id }}"><b>{{ user.get_full_name }}</b></a><br>
                                верстальщик, дизайнер, разработчик<br>
                                <span class="invite-user-item-rate">Закрыто задач: {{ user.todo.count }} ({{ user.get_profile.rating }})</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <hr>
            <div class="js-tasks invite-tasks">
                {% if not tasks and draft.author.id == request.user.id %}
                    <div class="task-wrapper">
                        <div class="task" style="padding:10px; line-height: 31px;">
                            Нет задач без исполнителей в списке.
                            <form action="/taskdraft/{{ draft.slug }}" method="POST" style="display: inline-block; float: right;">
                                {% csrf_token %}
                                <input type="hidden" name="_method" value="DELETE"/>
                                <a class="btn btn-danger"  href="" title="Удалить список" onclick="javascript:$(this).parents('form').trigger('submit');return false;">
                                    <i class="fa-trash-o fa"></i>&nbsp;Удалить список
                                </a>
                            </form>
                            <form action="/taskdraft/{{ draft.slug }}" method="POST" style="display: inline-block; float: right; margin-right: 10px;">
                                {% csrf_token %}
                                <input type="hidden" name="_method" value="PUT"/>
                                <input type="hidden" name="set_status" value="close"/>
                                <a class="btn btn-warning" href="" title="Закрыть список" onclick="javascript:$(this).parents('form').trigger('submit');return false;">
                                    <i class="fa-times-circle fa"></i>&nbsp;Закрыть список
                                </a>
                            </form>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% block javascript %}
    <script language="javascript">
        (function(){
            window.taskHtml = {{ tasks_template|jsonify|safe }};

            var aTaskList = [],taskRespSummary = {};
            {% for task in tasks %}
                aTaskList.push({{ task|jsonify|safe }});
                taskRespSummary['{{ task.id }}'] = {{ responsible_list|jsonify|safe }}
                {% if task.time %}
                    arTimers['{{ task.id }}'] = new PM_Timer({{ task.time|jsonify|safe }});
                    {% if task.startedTimerExist %}
                        arTimers['{{ task.id }}'].start();
                    {% endif %}
                {% endif %}
            {% endfor %}
            window.heliardData = {
                responsibleTag: '{% if draft.author.id == request.user.id %}a{% else %}span{% endif %}',
                draft: {
                    id: {{ draft.id }},
                    slug: '{{ draft.slug }}'
                },
                aTaskList: aTaskList,
                taskRespSummary: taskRespSummary
            };
        })();
    </script>
    {% compressed_js 'taskdraft_detail' %}
{% endblock %}

{% endblock %}
