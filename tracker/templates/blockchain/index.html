{% extends "main/base.html" %}
{% block header %}
{% endblock %}
{% block content %}
    <h1>Блокчейн opengift</h1>
    {% if not request.user.get_profile.blockchain_cert %}
        <div class="well">
            <h4>Регистрация</h4>
            <hr>
            <p>Зарегистрируйтесь в система под именем {{ request.user.username }}</p>
            <div>
                <input type="button" value="Зарегистрироваться" class="js-register btn btn-success"/>
            </div>
            <div class="js-registration-result" style="display: none;">
                <br />
                <p>Пожалуйста, скопируйте ваш ключ и сертификат. Никому не сообщайте свой приватный ключ.</p>
                <textarea class="form-control" style="height: 300px;"></textarea>
            </div>
        </div>
    {% endif %}
    <div class="well js-get-wallet" {% if not request.user.get_profile.blockchain_cert %}style="display: none;" {% endif %}>
        <h4>Мой кошелек</h4>
        <hr>
        <p>Код кошелька: <span class="js-wallet-code">{{ request.user.get_profile.blockchain_wallet|default_if_none:'' }}</span></p>
        <p>Баланс: <b class="js-wallet-balance"></b> OGFT</p>
        <p>Участие в проектах: <span class="js-projects-balance"></span></p>
        <p>Создать проект: <input type="text" name="" class="js-project-name" value=""/> <input type="button" value="ОК" onclick="return addProject();" class="js-create-project" /> </p>
        <p>Перевести на счет: <input type="text" name="" class="js-target-wallet" value=""/> сумму <input type="text" name="" class="js-target-wallet-sum" value=""/> <input type="button" value="ОК" onclick="return pay($('.js-target-wallet').val(), $('.js-target-wallet-sum').val());" class="js-send-coins" /> </p>
        <p>Перевести на счет: <input type="text" name="" class="js-target-project-token-wallet" value=""/> <input type="text" name="" class="js-target-project-token-sum" value=""/> токенов проекта <input type="text" name="" class="js-target-project-token" value=""/> <input type="button" value="ОК" onclick="return move($('.js-target-project-token').val(), $('.js-target-project-token-wallet').val(), $('.js-target-project-token-sum').val());" class="js-move-tokens" /> </p>
        <p>Донейт проекту: <input type="text" name="" class="js-target-project" value=""/> <input type="text" name="" class="js-target-project-sum" value=""/> <input type="button" value="ОК" onclick="return donate($('.js-target-project').val(), $('.js-target-project-sum').val());" class="js-donate" /> </p>
    </div>
    <script>
        $(function() {
            $('.js-register').click(function() {
                var t = this;
                $(t).remove();
                $.post('/blockchain/ajax/', {'action':'register'}, function(data) {
                    $('.js-registration-result').show().find('textarea').html(data);
                    $('.js-get-wallet').show();
                    getKey();
                    getBalance();
                });
                return false;
            });
            var getKey = function() {
                $.post('/blockchain/ajax/', {'action':'getKey'}, function(data) {
                    $('.js-wallet-code').html(data);
                });
                return false;
            };


            {% if request.user.get_profile.blockchain_wallet %}
                getBalance();
            {% endif %}
        });
        var getBalance = function() {
                $.post('/blockchain/ajax/', {'action':'getBalance'}, function(data) {
                    data = $.parseJSON(data);
                    $('.js-wallet-balance').html(Math.round(data.Balance*10000)/10000);
                    if (data.Projects) {
                        var sp = '';
                        for (var i in data.Projects) {
                            sp += i + ': <b class="js-project-'+i+'"></b>%; ' ;
                            (function(inner) {
                                getProjectState(inner, function(sum) {$('.js-project-'+inner+'').text(sum);})
                            })(i);
                        }
                        $('.js-projects-balance').html(sp);
                    }
                });
                return false;
            };

        var addProject = function () {
                var pName = $('.js-project-name').val();
                $('.js-project-name').val('');
                $.post('/blockchain/ajax/', {'action':'addProject', 'pName': pName}, function(data) {
                    getBalance();
                });
            };

        var getProjectState = function(p, call) {
            $.post('/blockchain/ajax/', {'action':'getProjectVals', 'pName': p}, function(data) {
                data = $.parseJSON(data);
                call(data['Users'][$('.js-wallet-code').text()]);
            });
        };

        var pay = function(wallet, sum) {
            $.post('/blockchain/ajax/', {'action':'pay', 'wallet': wallet, 'sum': sum}, function(data) {
                getBalance();
            });
            $('.js-target-wallet-sum, .js-target-wallet').val('');
        };

        var move = function(project, wallet, qty) {
            $.post('/blockchain/ajax/', {'action':'move', 'project': project, 'qty': qty, 'wallet': wallet}, function(data) {
                getBalance();
            });
            $('.js-target-project-token-sum, .js-target-project-token, .js-target-project-token-wallet').val('');
        };

        var donate = function(project, qty) {
            $.post('/blockchain/ajax/', {'action':'donate', 'project': project, 'qty': qty}, function(data) {
                getBalance();
            });
            $('.js-target-project, .js-target-project-sum').val('');
        }
    </script>
{%  endblock %}